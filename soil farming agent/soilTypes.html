<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Soil Types</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link
      href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap"
      rel="stylesheet"
    />
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <style>
      body {
        font-family: "Poppins", sans-serif;
        background-color: #f5f5f5;
        flex-direction: row;
      }
      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }
      .soil-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
        flex-direction: row;
      }
      .chart-container {
        height: 300px;
        width: 100%;
      }
      .div {
        flex-direction: row;
      }
    </style>
  </head>
  <body>
    <!-- Navigation -->
    <nav class="gradient-bg text-white shadow-lg">
      <div class="container mx-auto px-6 py-3">
        <div class="flex items-center justify-between">
          <div class="flex items-center space-x-4">
            <img
              src="soils.jpeg"
              alt="Soil icon showing a shovel digging into rich dark soil"
              class="rounded-full"
            />
            <span class="text-xl font-semibold">Soil Explorer</span>
          </div>
          <div class="hidden md:flex space-x-8">
            <a href="#types" class="hover:text-gray-200">Soil Types</a>
            <a href="#features" class="hover:text-gray-200">Features</a>
            <a href="#calculator" class="hover:text-gray-200">Calculator</a>
            <a href="#forum" class="hover:text-gray-200">Forum</a>
          </div>
          <a href="login.html" id="login-button" class="btn"> Login </a>
        </div>
      </div>
    </nav>

    <!-- Hero Section -->
    <header class="gradient-bg text-white">
      <div class="container mx-auto px-6 py-20 text-center">
        <h1 class="text-4xl md:text-6xl font-bold mb-6">
          Discover the World Beneath Your Feet
        </h1>
        <p class="text-xl md:text-2xl mb-8">
          Explore different soil types, their properties, and innovative
          agricultural applications in soil farming
        </p>
      </div>
    </header>

    <!-- Main Content -->
    <main class="container mx-auto px-6 py-12">
      <!-- Soil Types Section -->
      <section id="types" class="mb-16">
        <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">
          Soil Types & Characteristics
        </h2>
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          <!-- Soil cards will be populated dynamically -->
          <div id="soil-cards-container">
            <!-- Cards will be inserted here by JavaScript -->
          </div>
        </div>
      </section>

      <!-- Soil Features Section -->
      <section id="features" class="mb-16 bg-white rounded-xl shadow-md p-8">
        <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">
          Advanced Soil Properties
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div class="space-y-6">
            <div class="bg-blue-50 p-6 rounded-lg">
              <h3 class="text-xl font-semibold mb-3 text-blue-800">
                Nutrient Retention
              </h3>
              <p>
                Different soils have varying capacities to hold essential
                nutrients like nitrogen, phosphorus, and potassium.
                Understanding this helps in effective fertilization.
              </p>
            </div>
            <div class="bg-green-50 p-6 rounded-lg">
              <h3 class="text-xl font-semibold mb-3 text-green-800">
                Water Holding Capacity
              </h3>
              <p>
                The ability of soil to retain water affects irrigation needs and
                drought resistance. Sandy soils drain quickly while clay retains
                water longer.
              </p>
            </div>
          </div>
          <div class="space-y-6">
            <div class="bg-yellow-50 p-6 rounded-lg">
              <h3 class="text-xl font-semibold mb-3 text-yellow-800">
                Carbon Sequestration
              </h3>
              <p>
                Modern research highlights soil's role in climate change
                mitigation through carbon storage. Certain soils like peat are
                particularly effective.
              </p>
            </div>
            <div class="bg-purple-50 p-6 rounded-lg">
              <h3 class="text-xl font-semibold mb-3 text-purple-800">
                Microbial Activity
              </h3>
              <p>
                Healthy soils host billions of microorganisms that contribute to
                nutrient cycling and plant health. Soil management affects this
                delicate ecosystem.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- Interactive Calculator -->
      <section
        id="calculator"
        class="mb-16 bg-gray-50 rounded-xl shadow-md p-8"
      >
        <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">
          Soil Analysis Calculator
        </h2>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
          <div>
            <div class="mb-6">
              <label class="block text-gray-700 mb-2">Select Soil Type</label>
              <select
                id="soil-select"
                class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              >
                <option value="">Choose a soil type</option>
                <option value="sandy">Sandy Soil</option>
                <option value="clay">Clay Soil</option>
                <option value="silt">Silt Soil</option>
                <option value="loam">Loam Soil</option>
                <option value="peat">Peat Soil</option>
              </select>
            </div>
            <div class="mb-6">
              <label class="block text-gray-700 mb-2">Area (sq ft)</label>
              <input
                type="number"
                id="area-input"
                class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
                placeholder="Enter area"
              />
            </div>
            <button
              id="calculate-btn"
              class="w-full bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300"
            >
              Calculate Nutrients
            </button>
          </div>
          <div
            id="calculator-results"
            class="bg-white rounded-lg p-6 shadow-inner"
          >
            <h3 class="text-xl font-semibold mb-4">Results</h3>
            <div id="results-content">
              <p class="text-gray-500">
                Select soil type and enter area to see recommended nutrient
                amounts.
              </p>
            </div>
            <div class="chart-container mt-4">
              <canvas id="soil-chart"></canvas>
            </div>
          </div>
        </div>
      </section>

      <!-- Community Forum -->
      <section id="forum" class="mb-16 bg-white rounded-xl shadow-md p-8">
        <h2 class="text-3xl font-bold mb-8 text-center text-gray-800">
          Soil Community Forum
        </h2>
        <div
          id="auth-message"
          class="mb-6 p-4 bg-yellow-50 rounded-md text-center"
        >
          <p>Please login to participate in discussions</p>
        </div>
        <div id="forum-content" class="hidden">
          <div class="mb-6">
            <textarea
              id="post-input"
              class="w-full px-4 py-2 rounded-md border border-gray-300 focus:outline-none focus:ring-2 focus:ring-indigo-500"
              rows="3"
              placeholder="Share your soil knowledge..."
            ></textarea>
            <button
              id="post-btn"
              class="mt-2 bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700 transition duration-300"
            >
              Post Discussion
            </button>
          </div>
          <div id="discussions-container" class="space-y-4">
            <!-- Discussions will be loaded here -->
          </div>
        </div>
      </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white py-12">
      <div class="container mx-auto px-6">
        <div class="grid grid-cols-1 md:grid-cols-4 gap-8">
          <div>
            <h3 class="text-xl font-semibold mb-4">Soil Explorer</h3>
            <p>
              Your comprehensive guide to understanding soil types and their
              agricultural applications.
            </p>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Resources</h4>
            <ul class="space-y-2">
              <li><a href="#" class="hover:text-gray-300">Soil Database</a></li>
              <li>
                <a href="#" class="hover:text-gray-300">Research Papers</a>
              </li>
              <li>
                <a href="#" class="hover:text-gray-300">Agriculture Tools</a>
              </li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Connect</h4>
            <ul class="space-y-2">
              <li><a href="#" class="hover:text-gray-300">Twitter</a></li>
              <li><a href="#" class="hover:text-gray-300">Facebook</a></li>
              <li><a href="#" class="hover:text-gray-300">Instagram</a></li>
            </ul>
          </div>
          <div>
            <h4 class="text-lg font-semibold mb-4">Newsletter</h4>
            <div class="flex">
              <input
                type="email"
                placeholder="Your email"
                class="px-4 py-2 rounded-l-md text-gray-800 w-full"
              />
              <button
                class="bg-indigo-600 px-4 py-2 rounded-r-md hover:bg-indigo-700"
              >
                Subscribe
              </button>
            </div>
          </div>
        </div>
        <div class="border-t border-gray-700 mt-8 pt-8 text-center">
          <p>&copy; 2025 Soil Explorer. All rights reserved.</p>
        </div>
      </div>
    </footer>

    <!-- Modal for detailed soil view -->
    <div
      id="soil-modal"
      class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 hidden"
    >
      <div
        class="bg-white rounded-lg w-full max-w-4xl mx-4 max-h-[90vh] overflow-y-auto"
      >
        <div class="p-6">
          <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-2xl font-bold"></h2>
            <button id="close-modal" class="text-gray-500 hover:text-gray-700">
              <svg
                xmlns="http://www.w3.org/2000/svg"
                class="h-6 w-6"
                fill="none"
                viewBox="0 0 24 24"
                stroke="currentColor"
              >
                <path
                  stroke-linecap="round"
                  stroke-linejoin="round"
                  stroke-width="2"
                  d="M6 18L18 6M6 6l12 12"
                />
              </svg>
            </button>
          </div>
          <div id="modal-content" class="space-y-4">
            <!-- Content will be loaded here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Firebase and Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
      // Firebase configuration
      const firebaseConfig = {
        apiKey: "AIzaSyDmw7FRzwZzRF4Z9qKAk9ei4NiX9Rk6J8U",
        authDomain: "soil-explorer-demo.firebaseapp.com",
        projectId: "soil-explorer-demo",
        storageBucket: "soil-explorer-demo.appspot.com",
        messagingSenderId: "829597250667",
        appId: "1:829597250667:web:0e311a1809b4065a49f1f2",
      };

      // Initialize Firebase
      firebase.initializeApp(firebaseConfig);
      const db = firebase.firestore();
      const auth = firebase.auth();

      // Soil data
      const soilData = [
        {
          id: 1,
          name: "Sandy Soil",
          color: "#f6d186",
          description: "Coarse texture with large particles, drains quickly.",
          properties: [
            "Drains quickly",
            "Low nutrient retention",
            "Warms up quickly in spring",
            "Easy to cultivate",
          ],
          composition: "80% sand, 10% silt, 10% clay",
          crops: "Carrots, potatoes, lettuce, berries",
          newTech: "Drip irrigation works best with moisture sensors",
          image: "sandysoil.jpeg",
          alt: "Close-up of sandy soil showing coarse texture and light color",
        },
        {
          id: 2,
          name: "Clay Soil",
          color: "#a58a75",
          description: "Fine texture with tiny particles, holds water well.",
          properties: [
            "High water retention",
            "Rich in nutrients",
            "Slow to warm in spring",
            "Compacts easily",
          ],
          composition: "20% sand, 20% silt, 60% clay",
          crops: "Cabbage, broccoli, kale, fruit trees",
          newTech: "Biochar amendment improves structure and drainage",
          image: "clay.jpeg",
          alt: "Close-up of clay soil showing smooth texture and reddish-brown color",
        },
        {
          id: 3,
          name: "Silt Soil",
          color: "#d4a373",
          description: "Soft and fertile with medium-sized particles.",
          properties: [
            "Holds moisture well",
            "Rich in nutrients",
            "Erodes easily",
            "Feels smooth and soapy",
          ],
          composition: "30% sand, 60% silt, 10% clay",
          crops: "Most vegetables, wheat, corn, legumes",
          newTech: "Cover cropping prevents erosion effectively",
          image: "silt.jpeg",
          alt: "Close-up of silt soil showing fine texture and light brown color",
        },
        {
          id: 4,
          name: "Loam Soil",
          color: "#b7b7a4",
          description: "Ideal mixture of sand, silt and clay.",
          properties: [
            "Balanced drainage and retention",
            "Rich in organic matter",
            "Easy to work with",
            "Ideal for most plants",
          ],
          composition: "40% sand, 40% silt, 20% clay",
          crops: "Almost all crops thrive in loam",
          newTech: "Precision agriculture maximizes yield potential",
          image: "loamysoil.jpeg",
          alt: "Close-up of loam soil showing crumbly texture and dark brown color",
        },
        {
          id: 5,
          name: "Peat Soil",
          color: "#5e503f",
          description: "High organic matter, dark and spongy.",
          properties: [
            "High water retention",
            "Acidic pH",
            "Low in nutrients",
            "Excellent for water filtration",
          ],
          composition: "90% organic matter, 10% mineral",
          crops: "Blueberries, cranberries, acid-loving plants",
          newTech: "Carbon sequestration potential is being studied",
          image: "peat.jpeg",
          alt: "Close-up of peat soil showing dark, spongy texture",
        },
        {
          id: 10,
          name: "Volcanic Soil",
          color: "#3d405b",
          description: "Highly fertile soil from volcanic ash.",
          properties: [
            "Exceptional fertility",
            "High water retention",
            "Rich in minerals",
            "Found near volcanoes",
          ],
          composition: "Volcanic glass, minerals, and organic matter",
          crops: "Coffee, grapes, citrus, tropical fruits",
          newTech: "Studied for carbon sequestration properties",
          image: "vol.jpeg",
          alt: "Close-up of volcanic soil showing dark color and porous texture",
        },
      ];

      // Render soil cards
      function renderSoilCards() {
        const container = document.getElementById("soil-cards-container");

        soilData.forEach((soil) => {
          const card = document.createElement("div");
          card.className =
            "soil-card bg-white rounded-xl shadow-md overflow-hidden transition duration-300 cursor-pointer";
          card.innerHTML = `
                    <div class="h-48" style="background-color: ${soil.color}">
                        <img src="${soil.image}" alt="${
            soil.alt
          }" class="w-full h-full object-cover">
                    </div>
                    <div class="p-6">
                        <h3 class="text-xl font-semibold mb-2">${soil.name}</h3>
                        <p class="text-gray-600 mb-3">${soil.description}</p>
                        <ul class="text-sm text-gray-500 mb-4">
                            ${soil.properties
                              .slice(0, 2)
                              .map((prop) => `<li class="mb-1">â€¢ ${prop}</li>`)
                              .join("")}
                        </ul>
                        <button class="mt-2 px-4 py-2 bg-blue-100 text-blue-700 rounded-md font-medium hover:bg-blue-200 transition duration-300 view-details-btn" data-id="${
                          soil.id
                        }">
                            View Details
                        </button>
                    </div>
                `;
          container.appendChild(card);
        });

        // Add event listeners to view details buttons
        document.querySelectorAll(".view-details-btn").forEach((btn) => {
          btn.addEventListener("click", (e) => {
            const soilId = parseInt(e.target.getAttribute("data-id"));
            showSoilDetails(soilId);
          });
        });
      }

      // Show soil details in modal
      function showSoilDetails(soilId) {
        const soil = soilData.find((s) => s.id === soilId);
        if (!soil) return;

        document.getElementById("modal-title").textContent = soil.name;
        const modalContent = document.getElementById("modal-content");

        modalContent.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div>
                        <img src="${soil.image}" alt="${
          soil.alt
        }" class="w-full rounded-lg">
                    </div>
                    <div>
                        <h3 class="text-lg font-semibold mb-2">Description</h3>
                        <p class="mb-4">${soil.description}</p>
                        
                        <h3 class="text-lg font-semibold mb-2">Properties</h3>
                        <ul class="list-disc pl-5 mb-4">
                            ${soil.properties
                              .map((prop) => `<li class="mb-1">${prop}</li>`)
                              .join("")}
                        </ul>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-4">
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Composition</h4>
                        <p>${soil.composition}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Suitable Crops</h4>
                        <p>${soil.crops}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-lg">
                        <h4 class="font-semibold mb-2">Modern Applications</h4>
                        <p>${soil.newTech}</p>
                    </div>
                </div>
                
                <div class="mt-6 bg-white border border-gray-200 rounded-lg p-4">
                    <h4 class="font-semibold mb-2">Soil Characteristics Chart</h4>
                    <div class="chart-container">
                        <canvas id="modal-chart"></canvas>
                    </div>
                </div>
                
                <div class="mt-6">
                    <h4 class="font-semibold mb-2">Save This Soil Info</h4>
                    <button id="save-soil-btn" class="px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700">Save to My Collection</button>
                    <div id="save-status" class="inline ml-4 text-sm"></div>
                </div>
            `;

        // Render chart in modal
        renderSoilModalChart(soil.name);

        // Show modal
        document.getElementById("soil-modal").classList.remove("hidden");

        // Save button event listener
        document
          .getElementById("save-soil-btn")
          ?.addEventListener("click", () => {
            saveSoilToCollection(soil);
          });
      }

      // Render chart in modal
      function renderSoilModalChart(soilName) {
        const ctx = document.getElementById("modal-chart").getContext("2d");

        // Sample data - in a real app this would be from a database
        const data = {
          sandy: [80, 10, 10, 45, 20, 2],
          clay: [20, 20, 60, 70, 5, 35],
          silt: [30, 60, 10, 60, 30, 5],
          loam: [40, 40, 20, 65, 25, 8],
          peat: [10, 0, 0, 90, 50, 1],
          volcanic: [30, 30, 40, 50, 30, 15],
        };

        const soilKey = soilName.toLowerCase().split(" ")[0];
        const soilValues = data[soilKey] || [40, 40, 20, 50, 20, 10];

        new Chart(ctx, {
          type: "radar",
          data: {
            labels: [
              "Sand %",
              "Silt %",
              "Clay %",
              "Fertility",
              "Drainage",
              "Water Holding",
            ],
            datasets: [
              {
                label: soilName,
                data: soilValues,
                backgroundColor: "rgba(75, 192, 192, 0.2)",
                borderColor: "rgba(75, 192, 192, 1)",
                borderWidth: 2,
              },
            ],
          },
          options: {
            scales: {
              r: {
                angleLines: {
                  display: true,
                },
                suggestedMin: 0,
                suggestedMax: 100,
              },
            },
          },
        });
      }

      // Save soil to user's collection
      function saveSoilToCollection(soil) {
        const user = auth.currentUser;
        if (!user) {
          alert("Please login to save soil information");
          return;
        }

        db.collection("userCollections")
          .doc(user.uid)
          .collection("savedSoils")
          .doc(soil.id.toString())
          .set({
            name: soil.name,
            description: soil.description,
            savedAt: new Date(),
            image: soil.image,
          })
          .then(() => {
            document.getElementById("save-status").textContent =
              "Saved successfully!";
            document.getElementById("save-status").className =
              "inline ml-4 text-sm text-green-600";
            setTimeout(() => {
              document.getElementById("save-status").textContent = "";
            }, 3000);
          })
          .catch((error) => {
            console.error("Error saving soil:", error);
            document.getElementById("save-status").textContent = "Error saving";
            document.getElementById("save-status").className =
              "inline ml-4 text-sm text-red-600";
          });
      }

      // Calculate soil nutrients
      function calculateNutrients() {
        const soilType = document.getElementById("soil-select").value;
        const area = parseFloat(document.getElementById("area-input").value);

        if (!soilType || !area || isNaN(area) || area <= 0) {
          alert("Please select soil type and enter a valid area");
          return;
        }

        // Sample calculations - in a real app these would be more sophisticated
        const calculations = {
          sandy: {
            nitrogen: Math.round(area * 0.5),
            phosphorus: Math.round(area * 0.3),
            potassium: Math.round(area * 0.4),
            organicMatter: Math.round(area * 0.2),
          },
          clay: {
            nitrogen: Math.round(area * 0.3),
            phosphorus: Math.round(area * 0.5),
            potassium: Math.round(area * 0.6),
            organicMatter: Math.round(area * 0.4),
          },
          silt: {
            nitrogen: Math.round(area * 0.4),
            phosphorus: Math.round(area * 0.4),
            potassium: Math.round(area * 0.5),
            organicMatter: Math.round(area * 0.3),
          },
          loam: {
            nitrogen: Math.round(area * 0.35),
            phosphorus: Math.round(area * 0.45),
            potassium: Math.round(area * 0.5),
            organicMatter: Math.round(area * 0.35),
          },
          peat: {
            nitrogen: Math.round(area * 0.2),
            phosphorus: Math.round(area * 0.2),
            potassium: Math.round(area * 0.3),
            organicMatter: Math.round(area * 0.8),
          },
        };

        const result = calculations[soilType] || calculations.loam;

        // Display results
        document.getElementById("results-content").innerHTML = `
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div class="bg-blue-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-blue-800">Nitrogen (N)</h4>
                        <p class="text-xl">${result.nitrogen} lbs</p>
                    </div>
                    <div class="bg-green-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-green-800">Phosphorus (P)</h4>
                        <p class="text-xl">${result.phosphorus} lbs</p>
                    </div>
                    <div class="bg-yellow-50 p-3 rounded-lg">
                        <h4 class="font-semibold text-yellow-800">Potassium (K)</h4>
                        <p class="text-xl">${result.potassium} lbs</p>
                    </div>
                    <div class="bg-brown-50 p-3 rounded-lg" style="background-color: #f0e6d2;">
                        <h4 class="font-semibold text-brown-800">Organic Matter</h4>
                        <p class="text-xl">${result.organicMatter} lbs</p>
                    </div>
                </div>
                <p class="text-sm text-gray-500">Recommendations based on ${area} sq ft of ${soilType} soil</p>
            `;

        // Update chart
        updateNutrientChart([
          result.nitrogen,
          result.phosphorus,
          result.potassium,
          result.organicMatter,
        ]);
      }

      // Update nutrient chart
      function updateNutrientChart(data) {
        const ctx = document.getElementById("soil-chart").getContext("2d");

        if (window.soilChart) {
          window.soilChart.destroy();
        }

        window.soilChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: ["Nitrogen", "Phosphorus", "Potassium", "Organic Matter"],
            datasets: [
              {
                label: "Nutrients Required (lbs)",
                data: data,
                backgroundColor: [
                  "rgba(54, 162, 235, 0.6)",
                  "rgba(75, 192, 192, 0.6)",
                  "rgba(255, 206, 86, 0.6)",
                  "rgba(153, 102, 255, 0.6)",
                ],
                borderColor: [
                  "rgba(54, 162, 235, 1)",
                  "rgba(75, 192, 192, 1)",
                  "rgba(255, 206, 86, 1)",
                  "rgba(153, 102, 255, 1)",
                ],
                borderWidth: 1,
              },
            ],
          },
          options: {
            scales: {
              y: {
                beginAtZero: true,
              },
            },
          },
        });
      }

      // Post discussion forum
      function postDiscussion() {
        const user = auth.currentUser;
        if (!user) {
          alert("Please login to post a discussion");
          return;
        }

        const content = document.getElementById("post-input").value.trim();
        if (!content) {
          alert("Please enter your discussion content");
          return;
        }

        db.collection("discussions")
          .add({
            content: content,
            userId: user.uid,
            userName: user.displayName || "Anonymous",
            createdAt: new Date(),
            likes: 0,
          })
          .then(() => {
            document.getElementById("post-input").value = "";
            loadDiscussions();
          })
          .catch((error) => {
            console.error("Error posting discussion:", error);
            alert("Error posting discussion");
          });
      }

      // Load discussions from Firestore
      function loadDiscussions() {
        db.collection("discussions")
          .orderBy("createdAt", "desc")
          .limit(10)
          .get()
          .then((querySnapshot) => {
            const container = document.getElementById("discussions-container");
            container.innerHTML = "";

            if (querySnapshot.empty) {
              container.innerHTML =
                '<p class="text-gray-500">No discussions yet. Be the first to post!</p>';
              return;
            }

            querySnapshot.forEach((doc) => {
              const data = doc.data();
              const discussion = document.createElement("div");
              discussion.className = "bg-gray-50 rounded-lg p-4";
              discussion.innerHTML = `
                            <div class="flex justify-between items-start mb-2">
                                <h4 class="font-semibold">${data.userName}</h4>
                                <span class="text-xs text-gray-500">${new Date(
                                  data.createdAt.seconds * 1000
                                ).toLocaleString()}</span>
                            </div>
                            <p class="mb-3">${data.content}</p>
                            <div class="flex justify-between items-center">
                                <button class="text-blue-600 hover:text-blue-800 like-btn" data-id="${
                                  doc.id
                                }">
                                    Like (${data.likes})
                                </button>
                                ${
                                  auth.currentUser &&
                                  auth.currentUser.uid === data.userId
                                    ? `
                                    <button class="text-red-600 hover:text-red-800 delete-btn" data-id="${doc.id}">
                                        Delete
                                    </button>
                                `
                                    : ""
                                }
                            </div>
                        `;
              container.appendChild(discussion);
            });

            // Add event listeners to like buttons
            document.querySelectorAll(".like-btn").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const docId = e.target.getAttribute("data-id");
                likeDiscussion(docId);
              });
            });

            // Add event listeners to delete buttons
            document.querySelectorAll(".delete-btn").forEach((btn) => {
              btn.addEventListener("click", (e) => {
                const docId = e.target.getAttribute("data-id");
                deleteDiscussion(docId);
              });
            });
          })
          .catch((error) => {
            console.error("Error loading discussions:", error);
          });
      }

      // Like a discussion
      function likeDiscussion(docId) {
        const user = auth.currentUser;
        if (!user) {
          alert("Please login to like discussions");
          return;
        }

        const docRef = db.collection("discussions").doc(docId);

        db.runTransaction((transaction) => {
          return transaction.get(docRef).then((doc) => {
            if (!doc.exists) {
              throw "Document does not exist!";
            }

            const newLikes = (doc.data().likes || 0) + 1;
            transaction.update(docRef, { likes: newLikes });
            return newLikes;
          });
        })
          .then(() => {
            loadDiscussions();
          })
          .catch((error) => {
            console.error("Transaction failed:", error);
          });
      }

      // Delete a discussion
      function deleteDiscussion(docId) {
        if (!confirm("Are you sure you want to delete this discussion?")) {
          return;
        }

        db.collection("discussions")
          .doc(docId)
          .delete()
          .then(() => {
            loadDiscussions();
          })
          .catch((error) => {
            console.error("Error deleting discussion:", error);
          });
      }

      // Auth state management
      function setupAuth() {
        auth.onAuthStateChanged((user) => {
          const authButton = document.getElementById("auth-button");
          const authMessage = document.getElementById("auth-message");
          const forumContent = document.getElementById("forum-content");

          if (user) {
            authButton.textContent = "Logout";
            authMessage.classList.add("hidden");
            forumContent.classList.remove("hidden");
          } else {
            authButton.textContent = "Login";
            authMessage.classList.remove("hidden");
            forumContent.classList.add("hidden");
          }
        });

        // Login/logout button
        document.getElementById("auth-button").addEventListener("click", () => {
          if (auth.currentUser) {
            auth.signOut();
          } else {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch((error) => {
              console.error("Auth error:", error);
            });
          }
        });
      }

      // Close modal
      document.getElementById("close-modal").addEventListener("click", () => {
        document.getElementById("soil-modal").classList.add("hidden");
      });

      // Calculate button
      document.getElementById("calculate-btn").addEventListener("click", () => {
        calculateNutrients();
      });

      // Post button
      document.getElementById("post-btn")?.addEventListener("click", () => {
        postDiscussion();
      });

      // Initialize the app when DOM is loaded
      document.addEventListener("DOMContentLoaded", () => {
        renderSoilCards();
        setupAuth();
        loadDiscussions();

        // Initial blank chart
        updateNutrientChart([0, 0, 0, 0]);
      });
    </script>
  </body>
</html>
